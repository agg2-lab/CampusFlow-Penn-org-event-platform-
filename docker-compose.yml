version: "3.9"

services:
  # ── MongoDB (events, check-ins, analytics) ──
  mongo:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: campusflow
      MONGO_INITDB_ROOT_PASSWORD: campusflow_secret
    volumes:
      - mongo_data:/data/db
    networks:
      - campus

  # ── MySQL (users, orgs, memberships, tickets) ──
  mysql:
    image: mysql:8
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root_secret
      MYSQL_DATABASE: campusflow
      MYSQL_USER: campusflow
      MYSQL_PASSWORD: campusflow_secret
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - campus

  # ── Redis (sessions, real-time pub/sub) ──
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - campus

  # ── Backend API (Express.js) ──
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      MONGO_URI: mongodb://campusflow:campusflow_secret@mongo:27017/campusflow?authSource=admin
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: campusflow
      MYSQL_PASSWORD: campusflow_secret
      MYSQL_DATABASE: campusflow
      REDIS_URL: redis://redis:6379
      JWT_SECRET: change-me-in-production
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      MAGIC_LINK_SECRET: ${MAGIC_LINK_SECRET}
      FRONTEND_URL: http://localhost:3000
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
    depends_on:
      - mongo
      - mysql
      - redis
    networks:
      - campus

  # ── Frontend (Next.js) ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://backend:4000/api
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
    depends_on:
      - backend
    networks:
      - campus

  # ── Nginx reverse proxy / CDN layer ──
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - campus

volumes:
  mongo_data:
  mysql_data:

networks:
  campus:
    driver: bridge
